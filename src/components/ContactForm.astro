---
import "../styles/components/ContactForm.css";
import { Icon } from "astro-icon/components";

const serviceTypes = [
  "Despacho aduanal",
  "Transporte marítimo",
  "Transporte aéreo",
  "Transporte terrestre",
  "Comercializadora",
  "Almacenaje / Depósito Fiscal",
  "Seguro de Mercancía",
  "Trámites Especiales (COFEPRIS/SEMARNAT)",
  "Otro",
];

// Configuración de Seguridad y Endpoint
const SCRIPT_URL = import.meta.env.PUBLIC_SCRIPT_URL;
const API_KEY = import.meta.env.PUBLIC_SCRIPT_API_KEY;
---

<section id="contact" class="contact-form-section">
  <div class="contact-container">
    <div class="contact-wrapper">
      <!-- Info Side -->
      <div class="contact-info">
        <h2>Contáctenos</h2>
        <p class="contact-desc">
          Solicite una cotización personalizada o resuelva sus dudas con
          nuestros especialistas.
        </p>

        <div class="contact-details">
          <div class="detail-item">
            <div class="detail-icon">
              <Icon name="lucide:map-pin" />
            </div>
            <div class="detail-text">
              <p>Dirección</p>
              <p>
                <a
                  href="https://maps.app.goo.gl/WPURMeqP3WiNCkNPA"
                  target="_blank"
                  >Jericó No.97, Col. Romero Rubio, Del. Venustiano Carranza,
                  CP. 15400, Ciudad de México, CDMX</a
                >
              </p>
            </div>
          </div>

          <div class="detail-item">
            <div class="detail-icon">
              <Icon name="lucide:mail" />
            </div>
            <div class="detail-text">
              <p>Email</p>
              <p>
                <a href="mailto:contacto@globalfreight.com" target="_blank"
                  >contacto@globalfreight.com</a
                >
              </p>
            </div>
          </div>

          <div class="detail-item">
            <div class="detail-icon">
              <Icon name="lucide:phone" />
            </div>
            <div class="detail-text">
              <p>Teléfono / WhatsApp</p>
              <p>
                <a href="tel:+5491112345678" target="_blank"
                  >+54 9 11 1234 5678</a
                >
              </p>
            </div>
          </div>
        </div>

        <div class="contact-social">
          <div class="social-icon">
            <a
              href="https://www.facebook.com/LightmanGlobal.LMG/?locale=es_LA"
              target="_blank"
            >
              <Icon name="lucide:facebook" />
            </a>
          </div>
          <div class="social-icon">
            <a href="https://www.instagram.com/lightmanglobal" target="_blank">
              <Icon name="lucide:instagram" />
            </a>
          </div>
          <div class="social-icon">
            <a href="https://x.com/lightmanglobal" target="_blank">
              <Icon name="lucide:twitter" />
            </a>
          </div>
        </div>
      </div>

      <!-- Form Side -->
      <div class="contact-form-wrapper">
        <div class="success-message" id="success-message">
          <div>
            <div class="success-icon-wrapper">
              <Icon name="lucide:check" />
            </div>
            <h3 class="success-title">¡Gracias!</h3>
            <p class="success-desc">
              Recibimos tu consulta con éxito. Un especialista comercial te
              contactará en breve.
            </p>
            <button class="btn-reset" id="reset-btn">
              Enviar otra consulta
            </button>
          </div>
        </div>

        <form id="contact-form" data-url={SCRIPT_URL} data-apikey={API_KEY}>
          <div class="form-grid">
            <div class="form-group">
              <label>Nombre y Apellido *</label>
              <input
                type="text"
                name="name"
                required
                class="form-input"
                placeholder="Ej: Juan Pérez"
              />
            </div>
            <div class="form-group">
              <label>Email *</label>
              <input
                type="email"
                name="email"
                required
                class="form-input"
                placeholder="juan@empresa.com"
              />
            </div>
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label>Empresa</label>
              <input
                type="text"
                name="company"
                class="form-input"
                placeholder="Nombre de su empresa"
              />
            </div>
            <div class="form-group">
              <label>Teléfono / WhatsApp</label>
              <input
                type="tel"
                name="phone"
                class="form-input"
                placeholder="+54 9 ..."
              />
            </div>
          </div>

          <div class="form-group" style="margin-bottom: 1.25rem;">
            <label>Tipo de Servicio</label>
            <select name="service" class="form-select">
              {serviceTypes.map((type) => <option value={type}>{type}</option>)}
            </select>
          </div>

          <div class="form-group" style="margin-bottom: 1.25rem;">
            <label>Mensaje *</label>
            <textarea
              name="message"
              required
              rows="4"
              class="form-textarea"
              placeholder="Cuéntenos sobre sus necesidades de transporte..."
            ></textarea>
          </div>

          <div class="hidden">
            <input
              type="text"
              name="website"
              tabindex="-1"
              autocomplete="off"
            />
          </div>

          <p class="error-message" id="error-message"></p>

          <button type="submit" class="btn-submit" id="submit-btn">
            <svg
              class="spinner"
              id="spinner"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
              ></path>
            </svg>
            <span id="btn-text">Solicitar Cotización Ahora</span>
          </button>

          <p class="disclaimer">
            Al enviar este formulario, usted acepta nuestra política de
            privacidad y el tratamiento de sus datos con fines comerciales.
          </p>
        </form>
      </div>
    </div>
  </div>
</section>

<script>
  const form = document.getElementById("contact-form") as HTMLFormElement;
  const submitBtn = document.getElementById("submit-btn") as HTMLButtonElement;
  const spinner = document.getElementById("spinner");
  const btnText = document.getElementById("btn-text");
  const errorMessage = document.getElementById("error-message");
  const successMessage = document.getElementById("success-message");
  const resetBtn = document.getElementById("reset-btn");

  if (
    form &&
    submitBtn &&
    spinner &&
    btnText &&
    errorMessage &&
    successMessage &&
    resetBtn
  ) {
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      // Reset states
      submitBtn.disabled = true;
      spinner.style.display = "block";
      btnText.innerText = "Enviando...";
      errorMessage.style.display = "none";

      const formData = new FormData(form);
      const data: any = Object.fromEntries(formData.entries());

      // Validation
      if (!data.name || !data.email || !data.message) {
        errorMessage.innerText =
          "Por favor complete todos los campos obligatorios.";
        errorMessage.style.display = "block";
        submitBtn.disabled = false;
        spinner.style.display = "none";
        btnText.innerText = "Solicitar Cotización Ahora";
        return;
      }

      // Payload con Seguridad
      const payload: any = {
        ...data,
        api_key: form.dataset.apikey,
        origin: window.location.hostname,
        pageUrl: window.location.href,
        userAgent: navigator.userAgent,
        source: "landing-logistica",
      };

      try {
        // Usamos URLSearchParams para asegurar que los caracteres UTF-8 (emojis, tildes)
        // se codifiquen correctamente antes de llegar a Google Apps Script.
        const body = new URLSearchParams(payload);

        await fetch(form.dataset.url || "", {
          method: "POST",
          mode: "no-cors",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded;charset=utf-8",
          },
          body: body,
        });

        // En modo no-cors no podemos leer la respuesta, pero si fetch no da error,
        // asumimos que llegó al servidor de Google (standard para GAS).
        successMessage.style.display = "flex";
        form.reset();

        // Auto reset after 10s
        setTimeout(() => {
          successMessage.style.display = "none";
        }, 10000);
      } catch (err) {
        console.error("Error submitting form:", err);
        errorMessage.innerText =
          "Hubo un error al enviar el formulario. Por favor, intente nuevamente.";
        errorMessage.style.display = "block";
      } finally {
        submitBtn.disabled = false;
        spinner.style.display = "none";
        btnText.innerText = "Solicitar Cotización Ahora";
      }
    });

    resetBtn.addEventListener("click", () => {
      successMessage.style.display = "none";
    });
  }
</script>
